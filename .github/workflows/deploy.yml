name: Deploy MATCON

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---- Build React (optional) ----
    # This builds React before deployment (faster deploy)
    - name: Build React app
      run: |
        cd mat-frontend
        npm install
        npm run build

    # ---- Package all project files ----
    - name: Create tar file
      run: |
        tar -czf matcon.tar.gz ./

    # ---- Copy artifact to EC2 ----
    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "matcon.tar.gz"
        target: "${{ secrets.EC2_PROJECT_DIR }}"

    # ---- Run deployment on EC2 ----
    - name: Execute on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd ${{ secrets.EC2_PROJECT_DIR }}
          tar -xzf matcon.tar.gz

          # Stop running containers
          docker compose down

          # Rebuild images
          docker compose build --no-cache

          # Start containers
          docker compose up -d
